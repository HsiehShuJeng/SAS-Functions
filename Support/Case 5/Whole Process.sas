DATA "List"N;	
	INPUT Kiosk :$8. Begin :YYMMDD10. End :$10. Locality :$6. Spectrum $8.;
	FORMAT Begin DATE9.;
	INFILE DATALINES;
DATALINES;
商店1 2016/9/8 2016/10/10 北部 體系2
商店2 2016/9/9 2016/10/11 北部 體系11
商店3 2016/9/10 2016/10/12 北部 體系11
商店4 2016/9/11 2016/10/11 北部 體系10
商店5 2016/9/12 2016/10/11 北部 體系12
商店6 2016/9/13 2016/10/11 北部 體系12
商店7 2016/9/14 2016/10/11 北部 體系22
商店8 2016/9/15 2016/10/11 北部 體系22
商店9 2016/9/16 2016/10/11 北部 體系22
商店10 2016/9/17 2016/10/11 北部 體系22
商店11 2016/9/18 2016/10/11 北部 體系22
商店12 2016/9/19 2016/10/11 北部 體系22
商店13 2016/9/20 2016/10/11 北部 體系22
商店14 2016/9/21 2016/10/11 北部 體系22
商店15 2016/9/22 2016/10/11 北部 體系10
商店16 2016/9/23 2016/10/11 北部 體系1
商店17 2016/9/24 2016/10/11 北部 體系23
商店18 2016/9/25 2016/10/11 北部 體系10
商店19 2016/9/26 2016/10/11 北部 體系1
商店20 2016/9/27 2016/10/11 北部 體系6
商店21 2016/9/28 2016/10/11 北部 體系10
商店22 2016/9/29 2016/10/11 北部 體系23
商店23 2016/9/30 2016/10/11 北部 體系12
商店24 2016/10/1 2016/10/11 北部 體系2
商店25 2016/10/2 2016/10/11 北部 體系23
商店26 2016/10/3 2016/10/11 北部 體系23
商店27 2016/10/4 2016/10/11 北部 體系23
商店28 2016/10/5 2016/10/11 北部 體系1
商店29 2016/10/6 2016/10/11 北部 體系1
商店30 2016/10/7 2016/10/11 北部 體系12
商店31 2016/10/8 2016/10/11 北部 體系1
商店32 2016/10/9 2016/10/11 北部 體系12
商店33 2016/10/10 2016/10/11 北部 體系10
商店34 2016/10/11 2016/10/11 北部 體系12
商店35 2016/10/12 2016/10/11 北部 體系10
商店36 2016/10/13 2016/10/11 北部 體系1
商店37 2016/10/14 2016/10/11 北部 體系12
商店38 2016/10/15 2016/10/11 北部 體系1
商店39 2016/10/16 2016/10/11 中部 體系1
商店40 2016/10/17 2016/10/11 中部 體系2
商店41 2016/10/18 2016/10/11 中部 體系23
商店42 2016/10/19 2016/10/11 中部 體系10
商店43 2016/10/20 2016/10/11 中部 體系12
商店44 2016/10/21 2016/10/11 中部 體系12
商店45 2016/10/22 2016/10/11 中部 體系2
商店46 2016/10/23 2016/10/11 中部 體系23
商店47 2016/10/24 2016/10/11 南部 體系12
商店48 2016/10/25 2016/10/11 南部 體系12
商店49 2016/10/26 2016/10/11 南部 體系23
商店50 2016/10/27 2016/10/11 南部 體系22
商店51 2016/10/28 2016/10/11 南部 體系1
商店52 2016/10/29 2016/10/11 南部 體系10
商店53 2016/10/30 2016/10/11 南部 體系23
商店54 2016/10/31 2016/10/11 南部 體系2
商店55 2016/11/1 2016/10/11 南部 體系1
商店56 2016/11/2 2016/10/11 南部 體系10
商店57 2016/11/3 2016/10/11 南部 體系1
商店58 2016/11/4 2016/10/11 南部 體系12
商店59 2016/11/5 2016/10/11 南部 體系12
商店60 2016/11/6 2017/1/17 南部 體系22
商店61 2016/11/7 2017/1/8 南部 體系21
商店62 2016/11/8 2017/1/8 東部 體系11
商店63 2016/11/9 2017/1/8 東部 體系23
;
RUN;

DATA "Basic Stats"N;
	INPUT Date :YYMMDD10. Number :BEST12.0 Times :BEST12.0 Items :BEST12.0 Contribution :BEST12.;
	FORMAT Date DATE9. Contribution 12.2;
	INFILE CARDS;
CARDS;
2016/9/8 14889987 24228516 33278098 42591246
2016/9/9 12228794 23809096 33411073 42411091
2016/9/10 12119326 20306100 31995029 43311841
2016/9/11 14761657 20411145 34489709 42071861
2016/9/12 13294894 21135084 30994414 43811546
2016/9/13 10553613 21802818 30417772 40956579
2016/9/14 11672070 22039830 34057304 42836636
2016/9/15 13314221 20312871 32596830 42375762
2016/9/16 11985535 24306149 34952429 43618860
2016/9/17 13615933 24015643 33733204 42166524
2016/9/18 14147917 21629856 33082017 43329799
2016/9/19 11937879 24187232 32201310 44940382
2016/9/20 12489044 24302886 34853029 43025263
2016/9/21 14165313 21631477 33534812 43760568
2016/9/22 14826734 21783910 30456070 42249120
2016/9/23 14669868 24281004 33696908 40270661
2016/9/24 12680754 24313947 33879809 40154300
2016/9/25 14702201 20683499 32908426 43958458
2016/9/26 14600571 22236640 34435629 40561752
2016/9/27 13315095 24389754 33512906 43084543
2016/9/28 13572333 23085623 32614955 40911610
2016/9/29 14995872 23810664 33762345 41729240
2016/9/30 11186269 23046910 30711191 42910740
2016/10/1 13401514 24827365 34995895 43830465
2016/10/2 14845756 21180513 34137373 42761854
2016/10/3 14398777 23242065 34467404 42298204
2016/10/4 14131043 21660944 31433021 42824956
2016/10/5 13358937 24503795 30495899 44078709
2016/10/6 13188990 20029024 30854235 43201772
2016/10/7 12353878 20960256 34678734 40403509
2016/10/8 11771129 20562552 31974324 42309665
2016/10/9 12463506 23561464 32458559 41781573
2016/10/10 14133455 20583484 32946220 42567307
2016/10/11 14739118 20247354 31044433 43573725
2016/10/12 11186125 22362066 31696144 43112396
2016/10/13 12124650 23370245 34566804 40675462
2016/10/14 13593973 21684936 30088757 40215951
2016/10/15 12198416 22771249 30752176 42333805
2016/10/16 12194710 24313102 33933792 42029932
2016/10/17 13741667 20355722 32190932 42899007
2016/10/18 13881401 23570486 30602319 43540060
2016/10/19 10383071 22416514 34766551 42014726
2016/10/20 12762610 22287086 30027914 40140453
2016/10/21 13936828 20354584 31473619 41064961
2016/10/22 10982738 20224478 30567099 42882434
2016/10/23 12213740 21397377 33561570 40218987
2016/10/24 11173283 20629011 31670905 42823455
2016/10/25 11803712 20546645 30165244 41918800
2016/10/26 10888298 23759110 33602837 40009667
2016/10/27 14731529 22390648 31013173 42742938
2016/10/28 12473824 22817363 34797003 41935019
2016/10/29 13123376 22596886 32053333 41523719
2016/10/30 12680280 24213884 30500418 41706153
2016/10/31 14965823 23009905 34152844 44996268
2016/11/1 14780808 23440550 32099877 44421608
2016/11/2 14818671 24551011 32874485 44220788
2016/11/3 14091084 22675980 30539414 44817557
2016/11/4 13703252 22914732 30925115 43557603
2016/11/5 13646222 20524837 30250398 44150179
2016/11/6 11900264 21708134 32923979 43785975
2016/11/7 14122396 22242799 32837486 41372504
2016/11/8 13835269 23104056 33282801 40278883
2016/11/9 11266958 23295673 32902615 40412210
;
RUN;

DATA INFO(DROP=Kiosk_TMP End_TMP);
	RETAIN Kiosk Begin End BASTION Locality Spectrum;
	FORMAT Kiosk BASTION $30. Begin End DATE9.;
	SET WORK."LIST"N(RENAME=(Kiosk=Kiosk_TMP End=End_TMP));
	Kiosk=CATS('"',SUBSTR(Kiosk_TMP,1,30),'"N');
	End=INPUT(End_TMP,YYMMDD10.);
	BASTION=CATS(PUT(Begin,DATE9.),'/',PUT(End,DATE9.), '/', SUBSTR(Locality,1,3));
RUN;

PROC SQL NOPRINT;
	SELECT Kiosk INTO :DEPARTMENTSTORES SEPARATED BY ', ' FROM WORK.INFO;
	SELECT BASTION INTO :DATES_LIST SEPARATED BY ',' FROM WORK.INFO;
QUIT;
%LET DATES_LIST=(&DATES_LIST);
%LET DEPARTMENTSTORES=(&DEPARTMENTSTORES);
%LET VariableNumber=%EVAL(%SYSFUNC(COUNT(&DEPARTMENTSTORES,%STR(,)))+1);
%GLOBAL RetainStatement;
%LET RetainStatement=;
%MACRO generateRetainStatement;
	%DO ProcessedVariable=1 %TO &VariableNumber;
		%IF &ProcessedVariable NE &VariableNumber %THEN
			%LET RetainStatement=&RetainStatement.%SCAN(&DEPARTMENTSTORES,&ProcessedVariable)%STR( %")%SCAN(&DATES_LIST,&ProcessedVariable,%STR(,()))%STR(%" );
		%ELSE 
			%LET RetainStatement=&RetainStatement.%SCAN(&DEPARTMENTSTORES,&ProcessedVariable)%STR( %")%SCAN(&DATES_LIST,&ProcessedVariable,%STR(,()))%STR(%");
	%END;
	%LET RetainStatement=%STR(RETAIN Date Number Times Items Contribution 0 )&RetainStatement%STR( ¥_³¡ ¤¤³¡ «n³¡ ªF³¡ 0;);
%MEND;
%generateRetainStatement
OPTIONS VALIDVARNAME=ANY;

%MACRO generateDesirableDataSet;
DATA IMEDIATE_DATASET;
	%UNQUOTE(&RetainStatement)
	SET WORK."BASIC STATS"N;
RUN;
DATA ULTIMATE_RESULT;
	SET IMEDIATE_DATASET;
	%DO ProcessedVariable=1 %TO &VariableNumber;
		IF Date GE INPUT(SCAN(%SCAN(&DEPARTMENTSTORES,&ProcessedVariable),1,'/'),DATE9.) AND Date LE INPUT(SCAN(%SCAN(&DEPARTMENTSTORES,&ProcessedVariable),2,'/'),DATE9.) 
			THEN 
				DO;
					IF COMPRESS(SCAN(%SCAN(&DEPARTMENTSTORES,&ProcessedVariable),3,'/')) EQ '¥_' THEN "¥_³¡"N="¥_³¡"N+1;
					ELSE IF COMPRESS(SCAN(%SCAN(&DEPARTMENTSTORES,&ProcessedVariable),3,'/')) EQ '¤¤' THEN "¤¤³¡"N="¤¤³¡"N+1;
					ELSE IF COMPRESS(SCAN(%SCAN(&DEPARTMENTSTORES,&ProcessedVariable),3,'/')) EQ '«n' THEN "«n³¡"N="«n³¡"N+1;
					ELSE "ªF³¡"N="ªF³¡"N+1;
					%SCAN(&DEPARTMENTSTORES,&ProcessedVariable)='1';		
				END;
		ELSE %SCAN(&DEPARTMENTSTORES,&ProcessedVariable)='0';
	%END;
RUN;
%_eg_conditional_dropds(IMEDIATE_DATASET)
%MEND;
%generateDesirableDataSet